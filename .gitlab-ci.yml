variables:
  DOCKER_REGISTRY: 172.26.97.56:5000
  IMAGE_NAME: "${DOCKER_REGISTRY}/${CI_PROJECT_NAME}"
  WEBHOOK: http://airfone.1programmer.com/wechatWork/groupChat?corpsecret=RvnNhoGisfZAvB_ioeJQV_KRgy7_rhdV3wBTI5kS2Fo
  
stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - curl $WEBHOOK -H 'Content-Type:application/json' -X POST -d "{\"message\":\"$CI_PROJECT_NAME 开始构建\",\"groupId\":\"GROUPCI\"}" || true
    - docker build -t "${IMAGE_NAME}:lastest" .
    - docker image tag "${IMAGE_NAME}:lastest" "${IMAGE_NAME}:$CI_COMMIT_SHA"
    - docker push "${IMAGE_NAME}:lastest"
    - docker push "${IMAGE_NAME}:$CI_COMMIT_SHA"

test:
  stage: test
  dependencies:
  - build
  script:
  - docker run --rm "${IMAGE_NAME}:${CI_COMMIT_SHA}" npm run test:unit

dev_deploy:
  stage: deploy
  before_script:
  - docker rm -f $CI_PROJECT_NAME || true
  script:
    - docker volume rm $CI_PROJECT_NAME || true
    - docker run -d --name $CI_PROJECT_NAME --mount source=$CI_PROJECT_NAME,target=/home/app/dist "${IMAGE_NAME}:${CI_COMMIT_SHA}"
    - curl $WEBHOOK -H 'Content-Type:application/json' -X POST -d "{\"message\":\"$CI_PROJECT_NAME 测试环境发布成功\",\"groupId\":\"GROUPCI\"}" || true
  dependencies:
  - test
  environment:
    name: dev
    url: http://${CI_PROJECT_NAME}.xiaoyanzhang.com/
  only:
    refs:
      - master